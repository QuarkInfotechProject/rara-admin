name: Deploy to Server

on:
  push:
    branches:
      - main

env:
  SSH_HOST: "202.51.70.78"
  SSH_USER: "ubuntu"
  SSH_PORT: "22"
  PROJECT_PATH: "/home/ubuntu/admin"   # <-- FIXED ABSOLUTE PATH
  BRANCH: "main"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ›ï¸ Checkout Code
      uses: actions/checkout@v3

    - name: ğŸ” SSH into Server and Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SSH_HOST }}
        username: ${{ env.SSH_USER }}
        port: ${{ env.SSH_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script_stop: false
        use_insecure_cipher: true

        script: |
          # Disable first-time SSH host prompt
          mkdir -p ~/.ssh
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
          chmod 600 ~/.ssh/config

          echo -e "\033[1;33mğŸš€ Starting deployment...\033[0m"

          echo -e "\033[1;36mğŸ“ Entering project directory...\033[0m"
          cd $PROJECT_PATH || { echo "âŒ ERROR: Project path not found"; exit 1; }

          echo -e "\033[1;35mğŸ” Pulling latest updates...\033[0m"
          git pull origin $BRANCH || { echo "âŒ Git pull failed"; exit 1; }
          echo -e "\033[0;32mâœ” Code updated.\033[0m"

          echo -e "\033[1;34mğŸ“¦ Installing dependencies...\033[0m"
          npm install || { echo "âŒ npm install failed"; exit 1; }
          echo -e "\033[0;32mâœ” Dependencies installed.\033[0m"

          echo -e "\033[1;33mğŸ”¨ Building project...\033[0m"
          npm run build || { echo "âŒ Build failed"; exit 1; }
          echo -e "\033[0;32mâœ” Build completed.\033[0m"

          echo -e "\033[1;36mâš™ï¸ Reloading PM2 (zero downtime)...\033[0m"
          pm2 reload ecosystem.config.js --update-env || pm2 start ecosystem.config.js
          echo -e "\033[0;32mâœ” PM2 reload complete.\033[0m"

          echo -e "\033[1;32mğŸ‰ Deployment successful!\033[0m"
