name: Deploy to Server

# Trigger deployment on push to main branch
on:
  push:
    branches:
      - main

# Environment variables (editable)
env:
  SSH_HOST: "202.51.70.78"                       # ğŸŒ Server IP
  SSH_USER: "ubuntu"                             # ğŸ‘¤ SSH username
  SSH_PORT: "22"                                 # ğŸ”Œ SSH port
  PROJECT_PATH: "admin"   # ğŸ“‚ Project directory
  BRANCH: "main"                                 # ğŸŒ± Git branch to deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # ğŸ›ï¸ Step 1: Checkout Code
    # -----------------------------
    - name: ğŸ›ï¸ Checkout Code
      uses: actions/checkout@v3

    # -----------------------------
    # ğŸ” Step 2: SSH + Deploy
    # -----------------------------
    - name: ğŸ” SSH into Server and Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SSH_HOST }}
        username: ${{ env.SSH_USER }}
        port: ${{ env.SSH_PORT }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script_stop: false
        skip_verify: true              # ğŸš« Skip SSH host-key checking (no first-time prompts)
        
        script: |
          # ğŸŒŸ START DEPLOYMENT
          echo -e "\033[1;33mğŸš€ Starting deployment...\033[0m"

          # -----------------------------
          # ğŸ“‚ Navigate to project
          # -----------------------------
          echo -e "\033[1;36mğŸ“ Switching to project directory...\033[0m"
          cd $PROJECT_PATH

          # -----------------------------
          # ğŸ”„ Pull Latest Changes
          # -----------------------------
          echo -e "\033[1;35mğŸ” Checking for latest updates...\033[0m"
          git pull origin $BRANCH
          echo -e "\033[0;32mâœ” Code updated.\033[0m"

          # -----------------------------
          # ğŸ“¦ Install Dependencies
          # -----------------------------
          echo -e "\033[1;34mğŸ“¦ Installing dependencies...\033[0m"
          npm install
          echo -e "\033[0;32mâœ” Dependencies installed.\033[0m"

          # -----------------------------
          # ğŸ”¨ Build Project
          # -----------------------------
          echo -e "\033[1;33mğŸ”¨ Building project...\033[0m"
          npm run build
          echo -e "\033[0;32mâœ” Build completed.\033[0m"

          # -----------------------------
          # âš™ï¸ Restart PM2
          # -----------------------------
          echo -e "\033[1;36mâš™ï¸ Restarting PM2 process...\033[0m"
          pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
          echo -e "\033[0;32mâœ” PM2 restarted.\033[0m"

          # -----------------------------
          # ğŸ‰ Done!
          # -----------------------------
          echo -e "\033[1;32mğŸ‰ Deployment complete! Everything is up to date.\033[0m"
