name: Deploy to Server

on:
  push:
    branches:
      - main

env:
  PROJECT_PATH: "/home/ubuntu/admin"
  BRANCH: "main"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” SSH + Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: false

          # THIS IS THE KEY FIX â€” these envs go inside the SSH session:
          envs: PROJECT_PATH,BRANCH

          script: |
            echo "ğŸš€ Starting deployment"

            echo "ğŸ“ Switching to project directory: $PROJECT_PATH"
            cd $PROJECT_PATH || { echo "âŒ Directory not found"; exit 1; }

            echo "ğŸ”„ Pulling latest code..."
            git pull origin $BRANCH || { echo 'âŒ Git pull failed'; exit 1; }

            echo "ğŸ“¦ Installing dependencies..."
            npm install --legacy-peer-deps

            echo "ğŸ”¨ Building project..."
            npm run build

            echo "âš™ï¸ Reloading PM2..."
            pm2 reload ecosystem.config.js --update-env || pm2 start ecosystem.config.js

            echo "ğŸ‰ Deployment complete!"
